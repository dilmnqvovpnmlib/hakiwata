<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><title>Hugo で Markdown が上手く Parse されない原因を調査してみた - haKiwata</title><meta name=description content="概要  こんにちは！前々回の記事で Table を表現する Markdown が上手く表示されないバグにハマってしまいました。今回は、そのバグをどのように調査して解決したかについての記録を残したいと思います。  背景  前々回の記事で CPU のアーキテクチャとレジスタの関係を表す表を記述しました。その Markdown の抜粋は以下になります。  | arch | syscall NR | | :---: | :---: | | x86 | eax |  このように記述すると、表の中の文字列が中央揃えに表示される想定でした。しかし、表示結果は以下のように左揃えになっています。   これは、想定していた挙動と違っていました。HTML で言うところの、table タグ の align 属性 が適用されていません。そのため、この Markdown の記述で表の文字列が中央揃えになるようにトラブルシューティングとその改善をしたいと思います。  目的  Table の中央揃えと右揃えを表す Markdown が上手く Parse されない原因を明らかにし、改善するプロセスを振り返ることがこの記事の目的です。まず、この原因が Hugo 側にあるのか、あるいは Markdwon Parser に原因があるのか、あるいはそれ以外なのかを調査します。そしてその調査結果に基づいて不具合を修正します。  調査プロセスと解決方法   この問題の原因は大きく 2 つに分けられます。Hugo に問題があるケースと Markdown Parser に問題があるケースです。そこで、まず、Hugo が採用している Markdown Parser 側からの調査を行いました。"><link rel="shortcut icon" href=https://hakiwata.jp/img/images/kiwata.png><link rel=stylesheet href=https://hakiwata.jp/css/ui.css><link rel=stylesheet href=https://hakiwata.jp/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway"><meta property="og:title" content="Hugo で Markdown が上手く Parse されない原因を調査してみた"><meta property="og:description" content="概要  こんにちは！前々回の記事で Table を表現する Markdown が上手く表示されないバグにハマってしまいました。今回は、そのバグをどのように調査して解決したかについての記録を残したいと思います。  背景  前々回の記事で CPU のアーキテクチャとレジスタの関係を表す表を記述しました。その Markdown の抜粋は以下になります。  | arch | syscall NR | | :---: | :---: | | x86 | eax |  このように記述すると、表の中の文字列が中央揃えに表示される想定でした。しかし、表示結果は以下のように左揃えになっています。   これは、想定していた挙動と違っていました。HTML で言うところの、table タグ の align 属性 が適用されていません。そのため、この Markdown の記述で表の文字列が中央揃えになるようにトラブルシューティングとその改善をしたいと思います。  目的  Table の中央揃えと右揃えを表す Markdown が上手く Parse されない原因を明らかにし、改善するプロセスを振り返ることがこの記事の目的です。まず、この原因が Hugo 側にあるのか、あるいは Markdwon Parser に原因があるのか、あるいはそれ以外なのかを調査します。そしてその調査結果に基づいて不具合を修正します。  調査プロセスと解決方法   この問題の原因は大きく 2 つに分けられます。Hugo に問題があるケースと Markdown Parser に問題があるケースです。そこで、まず、Hugo が採用している Markdown Parser 側からの調査を行いました。"><meta property="og:type" content="article"><meta property="og:url" content="https://hakiwata.jp/post/20210624/"><meta property="og:image" content="https://hakiwata.jp/img/images/kiwata.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-06-22T13:08:38+00:00"><meta property="article:modified_time" content="2021-06-22T13:08:38+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hakiwata.jp/img/images/kiwata.png"><meta name=twitter:title content="Hugo で Markdown が上手く Parse されない原因を調査してみた"><meta name=twitter:description content="概要  こんにちは！前々回の記事で Table を表現する Markdown が上手く表示されないバグにハマってしまいました。今回は、そのバグをどのように調査して解決したかについての記録を残したいと思います。  背景  前々回の記事で CPU のアーキテクチャとレジスタの関係を表す表を記述しました。その Markdown の抜粋は以下になります。  | arch | syscall NR | | :---: | :---: | | x86 | eax |  このように記述すると、表の中の文字列が中央揃えに表示される想定でした。しかし、表示結果は以下のように左揃えになっています。   これは、想定していた挙動と違っていました。HTML で言うところの、table タグ の align 属性 が適用されていません。そのため、この Markdown の記述で表の文字列が中央揃えになるようにトラブルシューティングとその改善をしたいと思います。  目的  Table の中央揃えと右揃えを表す Markdown が上手く Parse されない原因を明らかにし、改善するプロセスを振り返ることがこの記事の目的です。まず、この原因が Hugo 側にあるのか、あるいは Markdwon Parser に原因があるのか、あるいはそれ以外なのかを調査します。そしてその調査結果に基づいて不具合を修正します。  調査プロセスと解決方法   この問題の原因は大きく 2 つに分けられます。Hugo に問題があるケースと Markdown Parser に問題があるケースです。そこで、まず、Hugo が採用している Markdown Parser 側からの調査を行いました。"><meta name=twitter:card content="summary"><script async src="https://www.googletagmanager.com/gtag/js?id=G-YXCYPL25QW"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-YXCYPL25QW',{anonymize_ip:!1})}</script></head><body><header class="container no-print"><div class=u-header><nav class=bar><ul><li><a href=https://hakiwata.jp/><img class=icon-text src=https://hakiwata.jp/img/prev.svg></a></li><li><a href=https://hakiwata.jp/about>About</a></li><li><a href=https://hakiwata.jp/post>Post</a></li><li><a href=https://hakiwata.jp/scraps>Scraps</a></li><li><a href=https://hakiwata.jp/tags>Tags</a></li></ul></nav></div></header><main class=container><article><header><hgroup id=brand><h1>Hugo で Markdown が上手く Parse されない原因を調査してみた</h1><h5><time datetime="2021-06-22 13:08:38 +0000 UTC">Jun 22, 2021</time>
<span class=no-print>-
<a href=https://hakiwata.jp/tags/hugo>Hugo</a>
<span></h5></hgroup><hr class=sep></header><h2 id=概要>概要</h2><ul><li>こんにちは！<a href=https://hakiwata.jp/post/20210618/>前々回の記事</a>で Table を表現する Markdown が上手く表示されないバグにハマってしまいました。今回は、そのバグをどのように調査して解決したかについての記録を残したいと思います。</li></ul><h2 id=背景>背景</h2><ul><li><a href=https://hakiwata.jp/post/20210618/>前々回の記事</a>で CPU のアーキテクチャとレジスタの関係を表す表を記述しました。その Markdown の抜粋は以下になります。</li></ul><div class=highlight><pre class=chroma><code class=language-markdown data-lang=markdown>| arch | syscall NR |
| :---: | :---: |
| x86 | eax |
</code></pre></div><ul><li>このように記述すると、表の中の文字列が中央揃えに表示される想定でした。しかし、表示結果は以下のように左揃えになっています。</li></ul><p><img src=01_hakiwata.png alt=01_hakiwata.png></p><ul><li>これは、想定していた挙動と違っていました。HTML で言うところの、<code>table タグ</code> の <code>align 属性</code> が適用されていません。そのため、この Markdown の記述で表の文字列が中央揃えになるようにトラブルシューティングとその改善をしたいと思います。</li></ul><h2 id=目的>目的</h2><ul><li>Table の中央揃えと右揃えを表す Markdown が上手く Parse されない原因を明らかにし、改善するプロセスを振り返ることがこの記事の目的です。まず、この原因が Hugo 側にあるのか、あるいは Markdwon Parser に原因があるのか、あるいはそれ以外なのかを調査します。そしてその調査結果に基づいて不具合を修正します。</li></ul><h2 id=調査プロセスと解決方法>調査プロセスと解決方法</h2><ul><li><p>この問題の原因は大きく 2 つに分けられます。Hugo に問題があるケースと Markdown Parser に問題があるケースです。そこで、まず、Hugo が採用している Markdown Parser 側からの調査を行いました。</p></li><li><p>初めに、Hugo で使われている Markdown Parser を調べました。これは、普通にググれば出てきます。<code>Hugo v0.60.0</code> から <a href=https://github.com/yuin/goldmark>goldmark</a> が採用されているそうです。この背景は、<a href=http://inforno.net/articles/2019/12/25/hugo-now-uses-goldmark>goldmarkがHugoに採用された</a>や<a href=https://gohugo.io/news/0.60.0-relnotes/>Now CommonMark Compliant!</a>の記事が参考になります。</p></li><li><p>次に、この <a href=https://github.com/yuin/goldmark>goldmark</a> のソースコードの中で、Table 記法の Markdown を Parse する箇所を最初に確認しました。そもそも Parse するロジックが実装されているかを調査するためです。今回は、GitHub の左上の検索ボックスで <code>table</code> の文字列を入力して検索を行いました。実際に Table 記法を Parse してそうなファイルに当たりをつけました。そのファイルは以下です。</p></li></ul><ol><li><a href=https://github.com/yuin/goldmark/blob/75d8cce5b78c7e1d5d9c4ca32c1164f0a1e57b53/extension/ast/table.go>goldmark/extension/ast/table.go</a></li><li><a href=https://github.com/yuin/goldmark/blob/75d8cce5b78c7e1d5d9c4ca32c1164f0a1e57b53/extension/table.go>goldmark/extension/table.go</a></li><li><a href=https://github.com/yuin/goldmark/blob/75d8cce5b78c7e1d5d9c4ca32c1164f0a1e57b53/extension/table_test.go>goldmark/extension/table_test.go</a></li><li><a href=https://github.com/yuin/goldmark/blob/75d8cce5b78c7e1d5d9c4ca32c1164f0a1e57b53/extension/_test/table.txt>goldmark/extension/_test/table.txt</a></li></ol><ul><li>初めは、各ファイルに目を通していき、Parse のロジックがどの関数で行われているかを調査していました。しかし、よくよく考えると、<span style=color:#e47911>テストコード</span>を確認して、問題となるケースが正常に加味されているかを確認することを優先しました。そこで、検索結果の 1 つである <a href=https://github.com/yuin/goldmark/blob/75d8cce5b78c7e1d5d9c4ca32c1164f0a1e57b53/extension/table_test.go>goldmark/extension/table_test.go</a> のソースコードを確認しました。すると、以下の Markdown を <a href=https://github.com/yuin/goldmark>goldmark</a> の関数 に入力すると、align 属性を考慮した table タグのある HTML を吐き出す関数のテストが実装されていました。そのため、おそらく align 属性を Parse する Table 記法のロジックが実装されていることがわかりました。これらの調査により、Hugo 側に問題がありそうだと推測しました。</li></ul><div class=xCodeBlock_code><div class=highlight><pre class=chroma><code class=language-html data-lang=html>| abc | defghi |
:-: | -----------:
bar | baz</code></pre></div></div><div class=xCodeBlock_title>Parse 対象の Table 記法の Markdown</div><div class=xCodeBlock_code><div class=highlight><pre class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>table</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>thead</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>th</span> <span class=na>align</span><span class=o>=</span><span class=s>&#34;center&#34;</span><span class=p>&gt;</span>abc<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>th</span> <span class=na>align</span><span class=o>=</span><span class=s>&#34;right&#34;</span><span class=p>&gt;</span>defghi<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
    <span class=p>&lt;/</span><span class=nt>thead</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>tbody</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>td</span> <span class=na>align</span><span class=o>=</span><span class=s>&#34;center&#34;</span><span class=p>&gt;</span>bar<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>td</span> <span class=na>align</span><span class=o>=</span><span class=s>&#34;right&#34;</span><span class=p>&gt;</span>baz<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
    <span class=p>&lt;/</span><span class=nt>tbody</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>table</span><span class=p>&gt;</span></code></pre></div></div><div class=xCodeBlock_title>上述の Table 記法の Markdown を Parse した結果得られる想定の HTML</div><hr><ul><li>次に、Hugo で使用されている <a href=https://github.com/yuin/goldmark>goldmark</a> のバージョンの関係性について調査を行いました。検索ワードを変えつつググっていると、<a href=https://discourse.gohugo.io/t/obsolete-attribute-align-on-td-with-goldmark/25021>Obsolete attribute align on td with Goldmark</a> という記事に辿り着きました。この記事を読むと、<a href=https://github.com/yuin/goldmark>goldmark</a> の GitHub の <a href=https://github.com/gohugoio/hugo/issues/7244>issue#7244</a> へのリンクが貼られていました。この issue を読むと、Hugo のバージョンが <code>v0.75</code> 以上であれば、Markdown の Table 記法が適切に Parse されそうな雰囲気が感じられました。そこで、まず以下のコマンドで自分の環境の Hugo のバージョンを確認してみました。</li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>&gt; hugo version
Hugo Static Site Generator v0.65.3-211BA42A linux/amd64 BuildDate: 2020-02-23T09:59:37Z
</code></pre></div><ul><li>これにより、Hugo のバージョンが <code>v0.65.3</code> とかなり古いバイナリを使用していることがわかりました。したがって、issue にあったように、ひとまず Hugo のバージョンを上げることを検討しました。Docker を使って Hugo のバージョンが <code>v0.83.1</code> であるバイナリを使用して開発用サーバを起動して挙動を確認しました。その結果、以下の画像のように表の中の文字列が中央揃えになりました。やはり、Hugo のバージョンが低いことが悪かったようです。</li></ul><p><img src=02_hakiwata.png alt=02_hakiwata.png></p><h2 id=感想>感想</h2><ul><li>こうして、意図を持って Hugo のバージョンを上げることで、問題を解決することができました。段階を踏んで調査した結果、意図した挙動をした瞬間はとても嬉しかったです。これからもバグを踏んだりしたときは、落ち着いて修正をしていければと思いました。</li></ul><h2 id=参考>参考</h2><ul><li><a href=http://inforno.net/articles/2019/12/25/hugo-now-uses-goldmark>goldmarkがHugoに採用された</a></li><li><a href=https://gohugo.io/news/0.60.0-relnotes/>Now CommonMark Compliant!</a></li><li><a href=https://discourse.gohugo.io/t/obsolete-attribute-align-on-td-with-goldmark/25021>Obsolete attribute align on td with Goldmark</a></li><li><a href=https://github.com/gohugoio/hugo/issues/7244>issue#7244</a></li></ul></article><nav class="no-print post-nav"><a class=prev-post href=https://hakiwata.jp/post/20210622/><img class=icon-text src=https://hakiwata.jp/img/prev.svg>このブログを運用する目的</a>
<a class=next-post href=https://hakiwata.jp/post/20210628/>自作ブログの開発環境を Docker で移行した<img class=icon-text src=https://hakiwata.jp/img/next.svg></a></nav><section id=related><h4>See Also</h4><ul><li><a href=https://hakiwata.jp/post/20210611/>Hugo のテンプレートを修正してみた</a></li><li><a href=https://hakiwata.jp/post/20210430/>First Post</a></li></ul></section><hr class=sep></main><footer class="container no-print"><div class=u-footer><a href=https://github.com/dilmnqvovpnmlib><img class=icon-social src=https://hakiwata.jp/img/github.svg alt=Github></a>
<a href=https://twitter.com/bilmnpvovqnmlid><img class=icon-social src=https://hakiwata.jp/img/twitter.svg alt=Twitter></a>
<a href=https://hakiwata.jp/index.xml target=_blank><img class=icon-social src=https://hakiwata.jp/img/feed.svg alt=Feed></a><p>&copy; 2021 haKiwata</p><a href=#brand><img class=icon-text src=https://hakiwata.jp/img/toup.svg alt="To Up">
<span>Back to Up</span></a></div></footer></body></html>