<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><title>自作 OS 日記 (2) - haKiwata</title><meta name=description content="概要  こんにちは！前回に引き続き自作 OS 日記を付けたいと思います。このエントリでは 11 ~ 20 章までの記録を残したいと思います。  日記 2021 年 9 月 1 日 osbook_day11a  main 関数のリファクタリングを行いました。main 関数が大きすぎて大変でした。見た目の挙動は osbook_day10g と変わりません。  osbook_day11b  周期的に割り込むタイマを実装しました。一定のカウントが刻まれると、割り込みが入り、背景に文字列が表示されます。  osbook_day11c  前節よりも短い周期で割り込みを行わせ、その割り込み回数を計算します。  2021 年 9 月 2 日 osbook_day11d  複数のタイマを作成し、それらからのタイムアウト通知を受け取ることができるように修正しました。  osbook_day11e  Kernel で Root System Description Pointer を取得できるように修正しました。これは、後々 IO ポート番号を求めるのに役立ちます。  osbook_day12a  IO ポート番号を求めるのに必要な FADT というテーブルのデータを取得する実装を行いました。UI に変化はありません。  2021 年 9 月 3 日 osbook_day12b  ACPI PM タイマ (基準となる軸で、fadt->pm_tmr_blk から求められる。) を使用して Local APIC タイマの 1 カウントが何秒なのかを計測します。  osbook_day12c osbook_day12d osbook_day12e osbook_day12f 2021 年 9 月 4 日 osbook_day13a  協調的マルチタスクの機能を実装しました！  osbook_day13b  プリミティブなプリエンプティブマルチタスクの機能を実装しました！特にコンテキストスイッチの自動化を行いました。  osbook_day13c  マルチタスクが実装できるかを検証しました。Hello Window と TaskB Window のカウンタが 1 秒おきに切り替わっていることがわかります。しかし、カウンタは 2 秒間分のカウントを刻んでいます。  osbook_day13d  マルチタスクを管理するための TaskManager を実装しました。タスクを増やせば増やすほどマウスがカクつく問題が生じたので、次章以降で修正していきたいと思います！  2021 年 9 月 5 日 osbook_day14a  ランキューを作成して実行可能状態にあるタスクを保持する。処理が完了したタスクをランキューから取り出し Sleep させ、CPU が割り当てられないような機能を実装する。この節では、キーボードからの入力でタスクを Sleep させるか Wakeup させるかを適宜切り替える。  osbook_day14b osbook_day14c osbook_day14d 2021 年 9 月 6 日 osbook_day15a  ウィンドウの描画をメインスレッドで行うようにリファクタリングを行いました！これまでは TaskB とメインタスクの両方で画面の再描画を行っていました。しかし、それが原因でデータをの競合が発生し、ウィンドウを動かすと、そのゴミが残ってしまっていました。  osbook_day15b  ウィンドウにアクティブ/非アクティブの機能を追加しました！   この節通りにプログラムを実装すると、実行後すぐに TaskB のウィンドウが消えてしまいます。状況を切り分けてトラブルシューティングすると、main."><link rel="shortcut icon" href=https://hakiwata.jp/img/images/favicon.ico><link rel=stylesheet href=https://hakiwata.jp/css/ui.css><link rel=stylesheet href=https://hakiwata.jp/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway"><meta property="og:title" content="自作 OS 日記 (2)"><meta property="og:description" content="概要  こんにちは！前回に引き続き自作 OS 日記を付けたいと思います。このエントリでは 11 ~ 20 章までの記録を残したいと思います。  日記 2021 年 9 月 1 日 osbook_day11a  main 関数のリファクタリングを行いました。main 関数が大きすぎて大変でした。見た目の挙動は osbook_day10g と変わりません。  osbook_day11b  周期的に割り込むタイマを実装しました。一定のカウントが刻まれると、割り込みが入り、背景に文字列が表示されます。  osbook_day11c  前節よりも短い周期で割り込みを行わせ、その割り込み回数を計算します。  2021 年 9 月 2 日 osbook_day11d  複数のタイマを作成し、それらからのタイムアウト通知を受け取ることができるように修正しました。  osbook_day11e  Kernel で Root System Description Pointer を取得できるように修正しました。これは、後々 IO ポート番号を求めるのに役立ちます。  osbook_day12a  IO ポート番号を求めるのに必要な FADT というテーブルのデータを取得する実装を行いました。UI に変化はありません。  2021 年 9 月 3 日 osbook_day12b  ACPI PM タイマ (基準となる軸で、fadt->pm_tmr_blk から求められる。) を使用して Local APIC タイマの 1 カウントが何秒なのかを計測します。  osbook_day12c osbook_day12d osbook_day12e osbook_day12f 2021 年 9 月 4 日 osbook_day13a  協調的マルチタスクの機能を実装しました！  osbook_day13b  プリミティブなプリエンプティブマルチタスクの機能を実装しました！特にコンテキストスイッチの自動化を行いました。  osbook_day13c  マルチタスクが実装できるかを検証しました。Hello Window と TaskB Window のカウンタが 1 秒おきに切り替わっていることがわかります。しかし、カウンタは 2 秒間分のカウントを刻んでいます。  osbook_day13d  マルチタスクを管理するための TaskManager を実装しました。タスクを増やせば増やすほどマウスがカクつく問題が生じたので、次章以降で修正していきたいと思います！  2021 年 9 月 5 日 osbook_day14a  ランキューを作成して実行可能状態にあるタスクを保持する。処理が完了したタスクをランキューから取り出し Sleep させ、CPU が割り当てられないような機能を実装する。この節では、キーボードからの入力でタスクを Sleep させるか Wakeup させるかを適宜切り替える。  osbook_day14b osbook_day14c osbook_day14d 2021 年 9 月 6 日 osbook_day15a  ウィンドウの描画をメインスレッドで行うようにリファクタリングを行いました！これまでは TaskB とメインタスクの両方で画面の再描画を行っていました。しかし、それが原因でデータをの競合が発生し、ウィンドウを動かすと、そのゴミが残ってしまっていました。  osbook_day15b  ウィンドウにアクティブ/非アクティブの機能を追加しました！   この節通りにプログラムを実装すると、実行後すぐに TaskB のウィンドウが消えてしまいます。状況を切り分けてトラブルシューティングすると、main."><meta property="og:type" content="article"><meta property="og:url" content="https://hakiwata.jp/post/20210831/"><meta property="og:image" content="https://hakiwata.jp/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-08-30T19:11:00+00:00"><meta property="article:modified_time" content="2021-08-30T19:11:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@bilmnpvovqnmlid"><meta name=twitter:creator content="@bilmnpvovqnmlid"><meta property="twitter:image" content="https://hakiwata.jp/img/images/20210831.png"><meta property="og:title" content="自作 OS 日記 (2)"><meta property="og:url" content="https://hakiwata.jp/post/20210831/"><meta property="og:image" content="https://hakiwata.jp/img/images/20210831.png"><meta property="og:description" content><script async src="https://www.googletagmanager.com/gtag/js?id=G-YXCYPL25QW"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-YXCYPL25QW',{anonymize_ip:!1})}</script></head><body><header class="container no-print"><div class=u-header><nav class=bar><ul><li><a href=https://hakiwata.jp/><img class=icon-text src=https://hakiwata.jp/img/prev.svg></a></li><li><a href=https://hakiwata.jp/about>About</a></li><li><a href=https://hakiwata.jp/log>Log</a></li><li><a href=https://hakiwata.jp/post>Post</a></li><li><a href=https://hakiwata.jp/scraps>Scraps</a></li><li><a href=https://hakiwata.jp/tags>Tags</a></li></ul></nav></div></header><main class=container><article><header><hgroup id=brand><h1>自作 OS 日記 (2)</h1><h5><time datetime="2021-08-30 19:11:00 +0000 UTC">Aug 30, 2021</time>
<span class=no-print>-
<a href=https://hakiwata.jp/tags/os>OS</a>
<a href=https://hakiwata.jp/tags/kernel>Kernel</a>
<a href=https://hakiwata.jp/tags/c>C</a>
<span></h5></hgroup><hr class=sep></header><h2 id=概要>概要</h2><ul><li>こんにちは！前回に引き続き自作 OS 日記を付けたいと思います。このエントリでは 11 ~ 20 章までの記録を残したいと思います。</li></ul><h2 id=日記>日記</h2><h3 id=2021-年-9-月-1-日>2021 年 9 月 1 日</h3><h4 id=osbook_day11a>osbook_day11a</h4><ul><li>main 関数のリファクタリングを行いました。main 関数が大きすぎて大変でした。見た目の挙動は osbook_day10g と変わりません。</li></ul><p><img src=media/osbook_day11a.gif alt=osbook_day11a.gif></p><h4 id=osbook_day11b>osbook_day11b</h4><ul><li>周期的に割り込むタイマを実装しました。一定のカウントが刻まれると、割り込みが入り、背景に文字列が表示されます。</li></ul><p><img src=media/osbook_day11b.gif alt=osbook_day11b.gif></p><h4 id=osbook_day11c>osbook_day11c</h4><ul><li>前節よりも短い周期で割り込みを行わせ、その割り込み回数を計算します。</li></ul><p><img src=media/osbook_day11c.gif alt=osbook_day11c.gif></p><h3 id=2021-年-9-月-2-日>2021 年 9 月 2 日</h3><h4 id=osbook_day11d>osbook_day11d</h4><ul><li>複数のタイマを作成し、それらからのタイムアウト通知を受け取ることができるように修正しました。</li></ul><p><img src=media/osbook_day11d.gif alt=osbook_day11d.gif></p><h4 id=osbook_day11e>osbook_day11e</h4><ul><li>Kernel で Root System Description Pointer を取得できるように修正しました。これは、後々 IO ポート番号を求めるのに役立ちます。</li></ul><p><img src=media/osbook_day11e.gif alt=osbook_day11e.gif></p><h4 id=osbook_day12a>osbook_day12a</h4><ul><li>IO ポート番号を求めるのに必要な FADT というテーブルのデータを取得する実装を行いました。UI に変化はありません。</li></ul><h3 id=2021-年-9-月-3-日>2021 年 9 月 3 日</h3><h4 id=osbook_day12b>osbook_day12b</h4><ul><li>ACPI PM タイマ (基準となる軸で、fadt->pm_tmr_blk から求められる。) を使用して Local APIC タイマの 1 カウントが何秒なのかを計測します。</li></ul><p><img src=media/osbook_day12b.gif alt=osbook_day12b.gif></p><h4 id=osbook_day12c>osbook_day12c</h4><p><img src=media/osbook_day12c.gif alt=osbook_day12c.gif></p><h4 id=osbook_day12d>osbook_day12d</h4><p><img src=media/osbook_day12d.gif alt=osbook_day12d.gif></p><h4 id=osbook_day12e>osbook_day12e</h4><p><img src=media/osbook_day12e.gif alt=osbook_day12e.gif></p><h4 id=osbook_day12f>osbook_day12f</h4><p><img src=media/osbook_day12f.gif alt=osbook_day12f.gif></p><h3 id=2021-年-9-月-4-日>2021 年 9 月 4 日</h3><h4 id=osbook_day13a>osbook_day13a</h4><ul><li>協調的マルチタスクの機能を実装しました！</li></ul><p><img src=media/osbook_day13a.gif alt=osbook_day13a.gif></p><h4 id=osbook_day13b>osbook_day13b</h4><ul><li>プリミティブなプリエンプティブマルチタスクの機能を実装しました！特にコンテキストスイッチの自動化を行いました。</li></ul><p><img src=media/osbook_day13b.gif alt=osbook_day13b.gif></p><h4 id=osbook_day13c>osbook_day13c</h4><ul><li>マルチタスクが実装できるかを検証しました。Hello Window と TaskB Window のカウンタが 1 秒おきに切り替わっていることがわかります。しかし、カウンタは 2 秒間分のカウントを刻んでいます。</li></ul><p><img src=media/osbook_day13c.gif alt=osbook_day13c.gif></p><h4 id=osbook_day13d>osbook_day13d</h4><ul><li>マルチタスクを管理するための TaskManager を実装しました。タスクを増やせば増やすほどマウスがカクつく問題が生じたので、次章以降で修正していきたいと思います！</li></ul><p><img src=media/osbook_day13d.gif alt=osbook_day13d.gif></p><h3 id=2021-年-9-月-5-日>2021 年 9 月 5 日</h3><h4 id=osbook_day14a>osbook_day14a</h4><ul><li>ランキューを作成して実行可能状態にあるタスクを保持する。処理が完了したタスクをランキューから取り出し Sleep させ、CPU が割り当てられないような機能を実装する。この節では、キーボードからの入力でタスクを Sleep させるか Wakeup させるかを適宜切り替える。</li></ul><p><img src=media/osbook_day14a.gif alt=osbook_day14a.gif></p><h4 id=osbook_day14b>osbook_day14b</h4><p><img src=media/osbook_day14b.gif alt=osbook_day14b.gif></p><h4 id=osbook_day14c>osbook_day14c</h4><p><img src=media/osbook_day14c.gif alt=osbook_day14c.gif></p><h4 id=osbook_day14d>osbook_day14d</h4><p><img src=media/osbook_day14d.gif alt=osbook_day14d.gif></p><h3 id=2021-年-9-月-6-日>2021 年 9 月 6 日</h3><h4 id=osbook_day15a>osbook_day15a</h4><ul><li>ウィンドウの描画をメインスレッドで行うようにリファクタリングを行いました！これまでは TaskB とメインタスクの両方で画面の再描画を行っていました。しかし、それが原因でデータをの競合が発生し、ウィンドウを動かすと、そのゴミが残ってしまっていました。</li></ul><p><img src=media/osbook_day15a.gif alt=osbook_day15a.gif></p><h4 id=osbook_day15b>osbook_day15b</h4><ul><li>ウィンドウにアクティブ/非アクティブの機能を追加しました！</li></ul><p><img src=media/osbook_day15b.gif alt=osbook_day15b.gif></p><ul><li>この節通りにプログラムを実装すると、実行後すぐに TaskB のウィンドウが消えてしまいます。状況を切り分けてトラブルシューティングすると、main.cpp 内でマウスを初期化する前に Taskb のウィンドウを初期化してしまうことが原因でした。自力で解決できたときは最高に嬉しかったです。その後、念の為、サポートページを確認すると、issues (<a href=https://github.com/uchan-nos/os-from-zero/issues/42>osbook_day15b で実行後すぐにTaskBウィンドウが消える</a>) の中で同様の質問をしている方がいらっしゃいました。解決方法が正しかったと確信を持ててよかったです。</li></ul><h3 id=2021-年-9-月-9-日>2021 年 9 月 9 日</h3><h4 id=osbook_day15c>osbook_day15c</h4><ul><li>ターミナルウィンドウの UI だけを作成しました！</li></ul><p><img src=media/osbook_day15c.gif alt=osbook_day15c.gif></p><h4 id=osbook_day15d>osbook_day15d</h4><ul><li>ウィンドウの描画の高速化を行いました！</li></ul><p><img src=media/osbook_day15d.gif alt=osbook_day15d.gif></p><h3 id=2021-年-9-月-10-日>2021 年 9 月 10 日</h3><h4 id=osbook_day16a>osbook_day16a</h4><ul><li>ターミナルに文字列を書き込めるようにしました！</li></ul><p><img src=media/osbook_day16a.gif alt=osbook_day16a.gif></p><h3 id=2021-年-9-月-11-日>2021 年 9 月 11 日</h3><h4 id=osbook_day16b>osbook_day16b</h4><ul><li><code>echo コマンド</code> を実装しました！</li></ul><p><img src=media/osbook_day16b.gif alt=osbook_day16b.gif></p><h4 id=osbook_day16c>osbook_day16c</h4><ul><li><code>clear コマンド</code> を実装しました！</li></ul><p><img src=media/osbook_day16c.gif alt=osbook_day16c.gif></p><h4 id=osbook_day16d>osbook_day16d</h4><ul><li><code>lspci コマンド</code> を実装しました！</li></ul><p><img src=media/osbook_day16d.gif alt=osbook_day16d.gif></p><h4 id=osbook_day16e>osbook_day16e</h4><ul><li>上矢印/下矢印でコマンドの履歴を遡れるようになりました！</li></ul><p><img src=media/osbook_day16e.gif alt=osbook_day16e.gif></p><h4 id=osbook_day16f>osbook_day16f</h4><ul><li><p>CPU のリソースを食いまくっている TaskB のウィンドウを削除しました。以下の top コマンドの差を見ると、削除した結果 QEMU が使用しているリソースが減っていることがわかると思います。</p></li><li><p>TaskB を削除する前の top コマンドの結果です。</p></li></ul><p><img src=media/osbook_day16f-result-of-top-command_bofore.png alt=osbook_day16f-result-of-top-command_bofore.png></p><ul><li>TaskB を削除した後の top コマンドの結果です。</li></ul><p><img src=media/osbook_day16f-result-of-top-command_bofore.png alt=osbook_day16f-result-of-top-command_bofore.png></p><ul><li>TaskB を削除しただけなので、特に変化はありません！</li></ul><p><img src=media/osbook_day16f.gif alt=osbook_day16f.gif></p><h3 id=2021-年-9-月-14-日>2021 年 9 月 14 日</h3><h4 id=osbook_day17a>osbook_day17a</h4><p><img src=media/osbook_day17a.gif alt=osbook_day17a.gif></p><h3 id=2021-年-9-月-15-日>2021 年 9 月 15 日</h3><h4 id=osbook_day17b>osbook_day17b</h4><p><img src=media/osbook_day17b.gif alt=osbook_day17b.gif></p><h3 id=2021-年-9-月-16-日>2021 年 9 月 16 日</h3><h4 id=osbook_day18a>osbook_day18a</h4><p><img src=media/osbook_day18a.gif alt=osbook_day18a.gif></p><h4 id=osbook_day18b>osbook_day18b</h4><ul><li>初めてアプリケーションを自作 OS 上で動作させた。ターミナルに <code>onlyhlt</code> コマンドを実行すると、ターミナルのプロセスが止まる。この節で OS とアプリケーションを全てビルドし、OS からアプリケーションを実行できるようなシェルスクリプトを実装した。</li></ul><p><img src=media/osbook_day18b.gif alt=osbook_day18b.gif></p><h3 id=2021-年-9-月-17-日>2021 年 9 月 17 日</h3><h4 id=osbook_day18c>osbook_day18c</h4><ul><li>この節では簡単な算術演算のコマンド <code>rpn</code> コマンドを追加で実装した。実装後、OS を起動させると、<code>rpn</code> コマンドが実行できない。また、<code>ls</code> コマンドも実行できないことにも気づいた。そのため、このバグをトラブルシューティングする必要があった。そこで、まずこの節で追加で実装した機能にバグが無いかを調査した。そして次に、そこにバグが無いことを確認した。これは、<code>git bisect</code> のようなやり方でどのタイミングで <code>ls</code> コマンドが正常な起動をしなくなったかを調査した。結論としては、アプリケーションを起動させる際に新たに使用するようになった <code>~/osbook/devenv/make_mikanos_image.sh</code> の中身の環境変数のパスを自分の OS 用に変更していなかったことが問題だった。変更点は以下である。書籍でも少し触れてくれても良いのではないかと思った。</li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>---
<span class=c1># LOADER_EFI=&#34;$HOME/edk2/Build/MikanLoaderX64/DEBUG_CLANG38/X64/Loader.efi&#34;</span>
<span class=c1># KERNEL_ELF=&#34;$MIKANOS_DIR/kernel/kernel.elf&#34;</span>
+++
<span class=nv>LOADER_EFI</span><span class=o>=</span><span class=nv>$HOME</span>/edk2/Build/HonoLoaderX64/DEBUG_CLANG38/X64/Loader.efi
<span class=nv>KERNEL_ELF</span><span class=o>=</span><span class=nv>$HOME</span>/honOS/kernel/kernel.elf
</code></pre></div><ul><li><p>こういったバグをできるだけ素早く気づき、どのケースでバグが発生しているかを確認するためにも、やはりテストコードを書くことは極めて重要だと痛感した。</p></li><li><p>また、この節で初めて気づいたのだが、日本語配列のキーボードで <code>+</code> を入力すると、<code>:</code> が出力されてしまう。色々なキーボードを押して確認していると、<code>+</code> を出力するためには、<code>shift + ^</code> を押さなければならない。</p></li></ul><p><img src=media/osbook_day18c.gif alt=osbook_day18c.gif></p><h4 id=osbook_day18d>osbook_day18d</h4><p><img src=media/osbook_day18d.gif alt=osbook_day18d.gif></p><h3 id=2021-年-9-月-18-日>2021 年 9 月 18 日</h3><h4 id=osbook_day19a>osbook_day19a</h4><ul><li>この章の仮想アドレスと物理アドレスの変換のロジックの実装が難しすぎて泣いた。</li></ul><p><img src=media/osbook_day19a.gif alt=osbook_day19a.gif></p><h3 id=2021-年-9-月-19-日>2021 年 9 月 19 日</h3><h4 id=osbook_day20a>osbook_day20a</h4><ul><li>アプリケーション (rpn) から Kernel の関数 (printk など) を呼び出しました。</li></ul><p><img src=media/osbook_day20a.gif alt=osbook_day20a.gif></p><h3 id=2021-年-9-月-20-日>2021 年 9 月 20 日</h3><h4 id=osbook_day20b>osbook_day20b</h4><p><img src=media/osbook_day20b.gif alt=osbook_day20b.gif></p><h4 id=osbook_day20c>osbook_day20c</h4><p><img src=media/osbook_day20c.gif alt=osbook_day20c.gif></p><h4 id=osbook_day20d>osbook_day20d</h4><p><img src=media/osbook_day20d.gif alt=osbook_day20d.gif></p><h3 id=2021-年-9-月-24-日>2021 年 9 月 24 日</h3><h4 id=osbook_day20e>osbook_day20e</h4><ul><li>やっとシステムコールを実装できました。感激です。ここまで来るとシステムプログラミングを下側の Kernel から見上げれます。</li></ul><p><img src=media/osbook_day20e.gif alt=osbook_day20e.gif></p><h2 id=参考>参考</h2><ul><li><a href=https://github.com/dilmnqvovpnmlib/honOS>honOS</a></li><li><a href=https://github.com/uchan-nos/mikanos>mikanos</a></li></ul></article><nav class="no-print post-nav"><a class=prev-post href=https://hakiwata.jp/post/20210830/><img class=icon-text src=https://hakiwata.jp/img/prev.svg>自作 OS 日記 (1)</a>
<a class=next-post href=https://hakiwata.jp/post/20210901/>自作 OS 日記 (3)<img class=icon-text src=https://hakiwata.jp/img/next.svg></a></nav><section id=related><h4>See Also</h4><ul><li><a href=https://hakiwata.jp/post/20210830/>自作 OS 日記 (1)</a></li><li><a href=https://hakiwata.jp/post/20210618/>システムコール番号を使って
write システムコールを呼び出す</a></li></ul></section><hr class=sep></main><footer class="container no-print"><div class=u-footer><a href=https://github.com/haytok><img class=icon-social src=https://hakiwata.jp/img/github.svg alt=Github></a>
<a href=https://twitter.com/bilmnpvovqnmlid><img class=icon-social src=https://hakiwata.jp/img/twitter.svg alt=Twitter></a>
<a href=https://hakiwata.jp/index.xml target=_blank><img class=icon-social src=https://hakiwata.jp/img/feed.svg alt=Feed></a><p>&copy; 2021 haKiwata</p><a href=#brand><img class=icon-text src=https://hakiwata.jp/img/toup.svg alt="To Up">
<span>Back to Up</span></a></div></footer></body></html>