---
draft: true
title: "システムコール番号を使って write システムコールを呼び出す"
date: 2021-06-18T02:21:38+09:00
tags: ["C", "Assembler"]
favorite: false
---

## 概要

- こんにちは！最近、低レイヤ寄りの実装に興味があり、[Linux Kernel](https://github.com/torvalds/linux) のシステムコール周りのソースコードを読む機会がありました。その際に、システムコールには、対応するシステムコール番号があるのを知りました。そこで、今回は C 言語やアセンブリ言語を書くことを通して、[write](https://linuxjm.osdn.jp/html/LDP_man-pages/man2/write.2.html) システムコールにおけるシステムコール番号とシステムコールの関係性について調査してみたいと思います。

## 背景と目的

- あるとき、[socket](https://linuxjm.osdn.jp/html/LDP_man-pages/man2/socket.2.html) システムコールは第三引数の `protocol` に応じてどのような処理が行われているかが気になったことがありました。その際、[socket](https://linuxjm.osdn.jp/html/LDP_man-pages/man2/socket.2.html) システムコールのプログラムを [Linux Kernel](https://github.com/torvalds/linux) から紐解く静的解析を行いました。静的解析でプログラムを追っていくと、[write](https://linuxjm.osdn.jp/html/LDP_man-pages/man2/write.2.html) システムコールが呼び出されていることに気づきました。このことがキッカケで、一番プリミティブで親近感のある [write](https://linuxjm.osdn.jp/html/LDP_man-pages/man2/write.2.html) システムコールの実装やシステムコール番号との関係性に興味を持ちました。

- そこで、今回は検証プログラムを実装することを通して、[write](https://linuxjm.osdn.jp/html/LDP_man-pages/man2/write.2.html) システムコールにおけるシステムコール番号とシステムコールの関係性を明らかにします。

## 方法

- 以下の 1 と 2 の順序で検証を行います。

1. まず、システムコール番号と [syscall](https://linuxjm.osdn.jp/html/LDP_man-pages/man2/syscall.2.html) 関数を使用して標準出力に文字列を出力する C 言語のプログラムを実装します。これにより、システムコール番号とシステムコールの対応関係に対する理解を深めます。

2. そして、その次に、アセンブリ言語でシステムコールを呼び出すプログラムを実装します。そしてそのプログラムを C 言語で書いたプログラムから呼び出し、標準出力に文字列を出力させます。また、このアセンブリ言語は 32 bit と 64 bit の両方に対応するプログラムを実装します。

---

- では、まず 1 を検証したいと思います。

```bash
grep -ilr SYS_WRITE /usr/include/* 
```

```bash
/usr/include/asm-generic/unistd.h
/usr/include/bits/syscall.h
/usr/include/python2.7/pgenheaders.h
/usr/include/python2.7/sysmodule.h
/usr/include/python3.6/pgenheaders.h
/usr/include/python3.6/sysmodule.h
/usr/include/python3.6m/pgenheaders.h
/usr/include/python3.6m/sysmodule.h
/usr/include/x86_64-linux-gnu/bits/syscall.h
```

- 次に、まず 2 を検証したいと思います。

## 結果と結論

- 以上の結果より、[write](https://linuxjm.osdn.jp/html/LDP_man-pages/man2/write.2.html) システムコールにおけるシステムコール番号とシステムコールが対応していることを明らかにしました。C 言語やアセンブリ言語を使用した複数の視点を通して、検証することができて楽しかったです。この記事を推敲している段階で、似たようなことを書かれている [魅力的なLinuxシステムコールの世界](https://www.linkedin.com/pulse/%E9%AD%85%E5%8A%9B%E7%9A%84%E3%81%AAlinux%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B3%E3%83%BC%E3%83%AB%E3%81%AE%E4%B8%96%E7%95%8C-takao-shimizu/) という記事を見つけました。見つけた時は少し残念な気がしましたが、記事の方向性は悪くなかったと思いました。そのため、この記事を書ききった自分を褒めたいと思います。

## 参考

- [grepでファイル内を検索しよう](https://searchman.info/tips/1090.html)

- [dilmnqvovpnmlib/BinaryAnalysisBook](https://github.com/dilmnqvovpnmlib/BinaryAnalysisBook/tree/main/s6)
- [2021/05/08](https://github.com/dilmnqvovpnmlib/LowLevelProgramming/tree/main/log/20210508)
